@page "/add"
@page "/edit/{Id:int}"
@using DailyJournalApp.Models
@using DailyJournalApp.Services
@inject DatabaseService DbService
@inject NavigationManager NavManager

<div class="container mt-4" style="max-width: 600px;">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">@(Id == 0 ? "Write New Entry" : "Edit Entry")</h3>
        </div>
        <div class="card-body">
            <EditForm Model="@entryModel" OnValidSubmit="@SaveEntry">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label class="form-label fw-bold">Date</label>
                    <InputDate class="form-control" @bind-Value="entryModel.Date" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Title</label>
                    <InputText class="form-control" @bind-Value="entryModel.Title" placeholder="What happened today?" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Mood</label>
                    <InputSelect class="form-select" @bind-Value="entryModel.PrimaryMood">
                        <option value="Happy">😊 Happy</option>
                        <option value="Excited">🤩 Excited</option>
                        <option value="Neutral">😐 Neutral</option>
                        <option value="Sad">😢 Sad</option>
                        <option value="Stressed">😫 Stressed</option>
                        <option value="Grateful">🙏 Grateful</option>
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Journal Content</label>
                    <InputTextArea class="form-control" @bind-Value="entryModel.Content" rows="8" placeholder="Start writing here..." style="resize: none;" />
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success flex-grow-1">Save Entry</button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="Cancel">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }
    private JournalEntry entryModel = new JournalEntry { Date = DateTime.Today };

    protected override async Task OnInitializedAsync()
    {
        if (Id != 0)
        {
            var existing = await DbService.GetEntryByIdAsync(Id);
            if (existing != null)
            {
                entryModel = existing;
            }
        }
    }

    private async Task SaveEntry()
    {
        // 1. Check if we are trying to create a NEW entry (Id is 0)
        if (Id == 0)
        {
            // 2. Check if an entry already exists for this specific date
            var existing = await DbService.GetEntryByDateAsync(entryModel.Date);

            if (existing != null)
            {
                // 3. ASK THE USER what to do
                string action = await Application.Current.MainPage.DisplayActionSheet(
                    $"Entry exists for {entryModel.Date:MMM dd}",
                    "Cancel",
                    null,
                    "Combine (Add to bottom)",
                    "Overwrite (Replace entirely)");

                if (action == "Combine (Add to bottom)")
                {
                    // LOGIC: Merge old content + new content
                    existing.Content = existing.Content + "\n\n----------------\n" + entryModel.Content;

                    // (Optional) You could also merge moods or titles if you wanted
                    // existing.Title = existing.Title + " & " + entryModel.Title;

                    await DbService.SaveEntryAsync(existing);
                    NavManager.NavigateTo("/");
                    return;
                }
                else if (action == "Overwrite (Replace entirely)")
                {
                    // LOGIC: Reuse the ID but replace all data with new inputs
                    entryModel.Id = existing.Id;
                    // We proceed to the normal save line below...
                }
                else
                {
                    // User clicked Cancel
                    return;
                }
            }
        }

        // Normal Save (For new entries OR Overwrite)
        await DbService.SaveEntryAsync(entryModel);
        NavManager.NavigateTo("/");
    }

    private void Cancel()
    {
        NavManager.NavigateTo("/");
    }
}